<!doctype html>
<html lang="en">
<html>
	<title>Drum Machine</title>

<head>
	<style>
	a:link {color: orange;}
	a:visited {color: orange;}
	a:hover {color: orange;}
	a:active {color: orange;}
	body {color: gray;}
	</style>
</head>
<body>
	Set the drum machine <a href="../index.html">down</a>
	<canvas id="laCanvas" width="800" height="600" style="display: block;background: #000;position: absolute; left: 0px; top: 35px; margin:0px auto 0px auto;"></canvas>
</body>

<script>

	document.addEventListener('pointerdown', mouseDown);

	var audio_context = window.AudioContext || window.webkitAudioContext;
	var context = new audio_context();

	var canvas = document.getElementById('laCanvas');
	var canvasContext = canvas.getContext('2d');

	var seq = [
		[1,0,1,0,1,0,1,0],
		[0,0,0,0,1,0,0,0],
		[1,0,0.2,0,0,0,0,0]
	];
		
	var step = 0;
	var interval = 0.125;
	var wait_time = 0.1;
	var got_up_to = 0;
	
	setInterval(function() {
		var now = context.currentTime;
		
		var max_future_time = now + (wait_time * 1.5);
		if(got_up_to > now) {
			now = got_up_to;
		}
		
		while(now <= max_future_time) {
			step++;
			if (Math.random() <= (seq[0][step % seq[0].length])) {
				playHiHat(now);
			}
			if (Math.random() <= (seq[1][step % seq[1].length])) {
				playSnare(now);
			}
			if (Math.random() <= (seq[2][step % seq[2].length])) {
				playKick(now);
			}
			now += interval;
		}
		got_up_to = now;

		//Buttons

		mousePressed = false;
	}, wait_time*1000);
	
	function playKick(now) {
		var kick = new Kick();
		kick.trigger(now);
	}
	
	function playSnare(now) {
		var snare = new Snare();
		snare.trigger(now);
	}
	
	function playHiHat(now) {
		var hiHat = new HiHat();
		hiHat.trigger(now);
	}

	// https://dev.opera.com/articles/drum-sounds-webaudio/
	function Kick() {
	
		var osc = context.createOscillator();
		var gain = context.createGain();
		osc.connect(gain);
		gain.connect(context.destination)

		this.trigger = function(time) {
			osc.frequency.setValueAtTime(150, time);
			gain.gain.setValueAtTime(1, time);

			osc.frequency.exponentialRampToValueAtTime(0.01, time + 0.5);
			gain.gain.exponentialRampToValueAtTime(0.01, time + 0.5);

			osc.start(time);

			osc.stop(time + 0.5);
		}
	}

	// https://dev.opera.com/articles/drum-sounds-webaudio/
	function Snare() {

		function noiseBuffer() {
			var bufferSize = context.sampleRate;
			var buffer = context.createBuffer(1, bufferSize, context.sampleRate);
			var output = buffer.getChannelData(0);

			for (var i = 0; i < bufferSize; i++) {
				output[i] = Math.random() * 2 - 1;
			}

			return buffer;
		}

		var noise = context.createBufferSource();
		noise.buffer = noiseBuffer();
		var noiseFilter = context.createBiquadFilter();
		noiseFilter.type = 'highpass';
		noiseFilter.frequency.value = 1000;
		noise.connect(noiseFilter);

		var noiseEnvelope = context.createGain();
		noiseFilter.connect(noiseEnvelope);

		noiseEnvelope.connect(context.destination);

		var osc = context.createOscillator();
		osc.type = 'triangle';

		var oscEnvelope = context.createGain();
		osc.connect(oscEnvelope);
		oscEnvelope.connect(context.destination);

		this.trigger = function(time) {

			noiseEnvelope.gain.setValueAtTime(1, time);
			noiseEnvelope.gain.exponentialRampToValueAtTime(0.01, time + 0.2);
			noise.start(time)

			osc.frequency.setValueAtTime(100, time);
			oscEnvelope.gain.setValueAtTime(0.7, time);
			oscEnvelope.gain.exponentialRampToValueAtTime(0.01, time + 0.1);
			osc.start(time)

			osc.stop(time + 0.2);
			noise.stop(time + 0.2);
		}
	}

	// http://joesul.li/van/synthesizing-hi-hats/
	function HiHat(){
		var fundamental = 40;
		var ratios = [2, 3, 4.16, 5.43, 6.79, 8.21];

		var gain = context.createGain();

		// Bandpass
		var bandpass = context.createBiquadFilter();
		bandpass.type = "bandpass";
		bandpass.frequency.value = 10000;

		// Highpass
		var highpass = context.createBiquadFilter();
		highpass.type = "highpass";
		highpass.frequency.value = 7000;

		// Connect the graph
		bandpass.connect(highpass);
		highpass.connect(gain);
		gain.connect(context.destination);

		this.trigger = function(now) {
			// Create the oscillators
			ratios.forEach(function(ratio) {
			  var osc = context.createOscillator();
			  osc.type = "square";
			  // Frequency is the fundamental * this oscillator's ratio
			  osc.frequency.value = fundamental * ratio;
			  osc.connect(bandpass);
			  osc.start(now);
			  osc.stop(now + 0.3);
			});

			// Define the volume envelope
			gain.gain.setValueAtTime(0.00001, now);
			gain.gain.exponentialRampToValueAtTime(1, now + 0.02);
			gain.gain.exponentialRampToValueAtTime(0.3, now + 0.03);
			gain.gain.exponentialRampToValueAtTime(0.00001, now + 0.3);
		}
	}

	function buttonClass(x, y, radius) {
		this.x = x;
		this.y = y;
		this.radius = radius;


	}

	var mousePressed = false;
	var mouseX = 0;
	var mouseY = 0;

	function mouseDown(evt) {
		var rect = canvas.getBoundingClientRect(),
		root = document.documentElement;
		mouseX = evt.clientX - rect.left - root.scrollLeft;
		mouseY = evt.clientY - rect.top - root.scrollTop;

		console.log(mouseX + " " + mouseY)

		mousePressed = true;
	}

	
</script>
<body bgcolor="black"></body>
</html>